<!DOCTYPE html>
<html>
	<head>
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>End on Time Configuration</title>
		<link rel='stylesheet' type='text/css' href='css/slate.min.css'>
		<script src='js/slate.min.js'></script>
		<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
		<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0-alpha.1/handlebars.min.js"></script>
		<style>
			.title {
			padding: 15px 10px;
			text-transform: uppercase;
			font-family: 'PT Sans', sans-serif;
			font-size: 1.2em;
			font-weight: 500;
			color: #888888;
			text-align: center;
			}
		</style>
	</head>

  <body>
    <h1 class='title'>End on Time Configuration</h1>
        <script id="hb-template" type="text/x-handlebars-template">
	{{#if code_error}}
		<div class="item-container">
			<div class="item-container-content">
				<div class="item">
					<span style="color: red">{{code_error}}</span>
				</div>
			</div>
		</div>
	{{/if}}

	{{#unless code}}
			<div class="item-container">
				<div class="item-container-header">Give access to your Google Calendar</div>
				<div class="button-container">
		<a href="https://accounts.google.com/o/oauth2/v2/auth?response_type=code&access_type=offline&prompt=consent%20select_account&client_id=349666396245-t5rjap1al2lhpvdof8vinlohmpb99r73.apps.googleusercontent.com&redirect_uri=https://hipsmart.github.io/end-on-time/catchauth.html&scope=https://www.googleapis.com/auth/calendar.readonly">
				    <input id="authorize_button" type="button" class="item-button" value="AUTHORIZE">
		</a>
				</div>
			</div>
	{{/unless}}

	{{#if code}}      
		<input type="hidden" id="code" name="code" value="{{code}}">
		   
		<div class="item-container">
		  <div class="item-container-header">Event Filter</div>
		  <div class="item-container-content">
		    <label class="item">
			 <div class="item-input-wrapper">
			   <input id="event_filter_textbox" type="text" class="item-input" name="input-2" placeholder="e.g. EOT" maxlength="10">
			 </div>
		    </label>
		  </div>
		 <div class='item-container-footer'>You can specify a short bit of text that you can place at
			the beginning of calendar events that you want to activate the countdown feature. If specified, any
			calendar events without this prefix will be ignored.
		 </div>
		</div>
	
	    <div class='item-container'>
		 <div class='item-container-header'>Vibration</div>
		 <div class='item-container-content'>
		   <label class='item'>
			5 minutes before event ENDS
			<input id='vibrate_end_checkbox' type='checkbox' class='item-toggle' checked>
		   </label>
		    <label class='item'>
			5 minutes before event BEGINS
			<input id='vibrate_begin_checkbox' type='checkbox' class='item-toggle' checked>
		   </label>
		</div>
	    </div>
	
	    <div class='item-container'>
		 <div class='button-container'>
		   <input id='submit_button' type='button' class='item-button' value='SUBMIT'>
		 </div>
	    </div>
		  
			<div class="item-container">
			<div class="item-container-content">
				<div class="item">
					 Google Calendar is connected.
				</div>
			</div>
			<div class="item-container-footer">
				To completely disable access to your calendar, you need to visit the <a href="https://security.google.com/settings/security/permissions?pli=1">Google
				Account Permissions</a> page to revoke access to this watch application.
			</div>
		</div>
		
		
		       


		
	{{/if}}

        </script>
	</body>
	
        <script type="text/javascript">
            var json = window.location.hash;
            if (json) {
                json = json.substring(1);
            }
            else {
                json = "{}";
            }
            var conf = JSON.parse(json);
            var source = $("#hb-template").html();
            var template = Handlebars.compile(source);
            
            conf.CONFIG_URL = "https://hipsmart.github.io/end-on-time/config.html#"
            conf.CATCHAUTH_URL = "https://hipsmart.github.io/end-on-time/catchauth.html";
            $('body').append(template(conf));
        </script>
 
  <script>
  function getConfigData() {
    var eventFilterTextbox = document.getElementById('event_filter_textbox');
    var vibrateEndCheckbox = document.getElementById('vibrate_end_checkbox');
    var vibrateBeginCheckbox = document.getElementById('vibrate_begin_checkbox');
    var codeHiddenInput = document.getElementById('code');
 
    var options = {
		'event_filter': eventFilterTextbox.value,
		'vibrate_end': vibrateEndCheckbox.checked,
		'vibrate_begin': vibrateBeginCheckbox.checked,
		'code': codeHiddenInput.value
    };
    // Save for next launch
    localStorage['event_filter'] = options['event_filter'];
    localStorage['vibrate_end'] = options['vibrate_end'];
    localStorage['vibrate_begin'] = options['vibrate_begin'];
    localStorage['code'] = options['code'];
    console.log('Got options: ' + JSON.stringify(options));
    return options;
  }
  function getQueryParam(variable, defaultValue) {
    var query = location.search.substring(1);
    var vars = query.split('&');
    for (var i = 0; i < vars.length; i++) {
      var pair = vars[i].split('=');
      if (pair[0] === variable) {
        return decodeURIComponent(pair[1]);
      }
    }
    return defaultValue || false;
  }
 
  var submitButton = document.getElementById('submit_button');
  submitButton.addEventListener('click', function() {
    console.log('Submit');
    // Set the return URL depending on the runtime environment
    var return_to = getQueryParam('return_to', 'pebblejs://close#');
    document.location = return_to + encodeURIComponent(JSON.stringify(getConfigData()));
  });
  (function() {
    var eventFilterTextbox = document.getElementById('event_filter_textbox');
    var vibrateEndCheckbox = document.getElementById('vibrate_end_checkbox');
    var vibrateBeginCheckbox = document.getElementById('vibrate_begin_checkbox');
    var codeHiddenInput = document.getElementById('code');
    
    // Load any previously saved configuration, if available
    if(localStorage['code']) {
      vibrateEndCheckbox.checked = JSON.parse(localStorage['vibrate_end']);
      vibrateBeginCheckbox.checked = JSON.parse(localStorage['vibrate_begin']);
      eventFilterTextbox.value = localStorage['event_filter'];
      codeHiddenInput.value = localStorage['code'];
    }
  })();
  </script>
</html>